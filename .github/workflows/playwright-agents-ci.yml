name: Playwright Test Agents CI

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      test-granularity:
        description: '„ÉÜ„Çπ„ÉàÁ≤íÂ∫¶: basic / standard / comprehensive'
        required: false
        default: 'standard'
        type: choice
        options:
          - basic
          - standard
          - comprehensive
      app-repo-url:
        description: '„ÉÜ„Çπ„ÉàÂØæË±°„Ç¢„Éó„É™„ÅÆ„É™„Éù„Ç∏„Éà„É™URLÔºàÊú™ÊåáÂÆöÊôÇ„ÅØ cocomomojo/test_appÔºâ'
        required: false
        type: string
      manual-url:
        description: '„Éû„Éã„É•„Ç¢„É´„Éï„Ç°„Ç§„É´„ÅÆURLÔºàMarkdownÂΩ¢ÂºèÊÉ≥ÂÆöÔºâ'
        required: false
        type: string
      include-diff-only:
        description: 'Â∑ÆÂàÜ„Éô„Éº„Çπ„ÅÆ„Ç§„É≥„Éó„ÉÉ„Éà„Çí‰ΩøÁî®Ôºà2ÂõûÁõÆ‰ª•ÈôçÊé®Â•®Ôºâ'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  test-agents:
    runs-on: ubuntu-latest
    
    env:
      TEST_GRANULARITY: ${{ github.event.inputs.test-granularity || 'standard' }}
      APP_REPO_URL: ${{ github.event.inputs.app-repo-url || 'cocomomojo/test_app' }}
      MANUAL_URL: ${{ github.event.inputs.manual-url }}
      INCLUDE_DIFF_ONLY: ${{ github.event.inputs.include-diff-only || 'false' }}
    steps:
      # Step 1: test_app „Çí„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„ÉàÔºàÂèÇÁÖßÁî®Ôºâ
      - name: Checkout test_app
        uses: actions/checkout@v4
        with:
          repository: ${{ env.APP_REPO_URL }}
          path: test_app
      
      # Step 2: test_app-agents „Çí„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà
      - name: Checkout test_app-agents
        uses: actions/checkout@v4
        with:
          path: test_app-agents
      
      # Step 3: Node.js „Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: test_app-agents/package-lock.json
      
      # Step 4: test_app-agents „ÅÆ‰æùÂ≠òÈñ¢‰øÇ„Ç§„É≥„Çπ„Éà„Éº„É´
      - name: Install dependencies
        working-directory: test_app-agents
        run: npm ci
      
      # Step 5: test_app „ÅÆ Docker Compose „ÇíËµ∑Âãï
      - name: Start test_app with Docker Compose
        working-directory: test_app/infra
        run: docker compose -f docker-compose.ci.yml up -d --build
      
      # Step 6: „Ç¢„Éó„É™Ëµ∑ÂãïÂæÖÊ©ü
      - name: Wait for Application
        run: |
          timeout 120 bash -c 'until curl -f http://localhost:8080/actuator/health; do sleep 2; done'
          timeout 120 bash -c 'until curl -f http://localhost:5173; do sleep 2; done'
      
      # Step 6.5: „Éû„Éã„É•„Ç¢„É´„ÉªÂ∑ÆÂàÜ„ÅÆÂèñÂæó
      - name: Fetch Manual
        if: env.MANUAL_URL != ''
        working-directory: test_app-agents
        run: |
          curl -o specs/manual.md "${{ env.MANUAL_URL }}"
          echo "‚úÖ Manual fetched: specs/manual.md"
      
      - name: Detect Changes (Diff-based)
        if: env.INCLUDE_DIFF_ONLY == 'true'
        working-directory: test_app-agents
        run: |
          LAST_COMMIT=$(cat .test-state 2>/dev/null || echo "HEAD~1")
          git diff $LAST_COMMIT HEAD --stat > specs/changes-summary.md || true
          echo "## Changed Files" >> specs/changes-summary.md
          git diff $LAST_COMMIT HEAD --name-only >> specs/changes-summary.md || true
          echo "## Affected Tests" >> specs/changes-summary.md
          echo "Previous implementation: see specs/test-plan-v*.md" >> specs/changes-summary.md
          echo "‚úÖ Change detection done"
      # Step 7: Seed Test ÂÆüË°åÔºàtest_app-agents „Åã„ÇâÔºâ
      - name: Run Seed Test
        working-directory: test_app-agents
        env:
          PLAYWRIGHT_BASE_URL: http://localhost:5173
        run: npx playwright test seed.spec.ts
      
      # Step 8-12: ‰ª•Èôç„ÅÆ Agents Âá¶ÁêÜÔºàWiki16 „Å®Âêå„ÅòÔºâ
      - name: Initialize Playwright Agents
        working-directory: test_app-agents
        run: npx playwright init-agents --loop=vscode
      
      - name: Run Playwright Tests
        working-directory: test_app-agents
        env:
          PLAYWRIGHT_BASE_URL: http://localhost:5173
          TEST_GRANULARITY: ${{ env.TEST_GRANULARITY }}
          INCLUDE_DIFF_ONLY: ${{ env.INCLUDE_DIFF_ONLY }}
        run: |
          echo "üé® Test Granularity: ${{ env.TEST_GRANULARITY }}"
          echo "üìã Diff-only Mode: ${{ env.INCLUDE_DIFF_ONLY }}"
          npx playwright test --reporter=line,allure-playwright
        continue-on-error: true
      
      # Step 9: Allure „É¨„Éù„Éº„ÉàÂÖ¨Èñã
      - name: Install Allure CLI
        if: always()
        run: npm install -g allure-commandline

      - name: Generate Allure report
        if: always()
        working-directory: test_app-agents
        run: |
          if [ -d allure-results ]; then
            npx allure generate allure-results --clean -o allure-report
            echo "‚úÖ Allure report generated"
          else
            echo "‚ö†Ô∏è allure-results not found, skipping report generation"
          fi

      - name: Upload Allure report as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: test_app-agents/allure-report
          if-no-files-found: ignore

      - name: Deploy Allure report to GitHub Pages
        if: always() && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./test_app-agents/allure-report
      
      # Step 10: „ÉÜ„Çπ„ÉàÂÆüË°åÁä∂ÊÖã„ÇíË®òÈå≤ÔºàÂ∑ÆÂàÜ„Éô„Éº„ÇπÁî®Ôºâ
      - name: Store Test Execution State
        if: always()
        working-directory: test_app-agents
        run: |
          git rev-parse HEAD > .test-state
          git add .test-state
          git config user.name "CI"
          git config user.email "ci@example.com"
          git commit -m "test: Update test execution state" || true
          git push || true
      
      # Step 10: Docker Compose ÂÅúÊ≠¢
      - name: Stop Applications
        if: always()
        run: |
          docker compose -f test_app/infra/docker-compose.ci.yml down -v